---
title: "MixedRegression"
author: "Tim Schneegans"
date: "4 Januar 2021"
output: html_document
---


```{r}
setwd("C:/Users/User/GitHub/WebET_Analysis")
getPackages <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

getPackages(c('dplyr', 
              "effsize",
              'e1071',
              "ggplot2",
              "ggsignif",
              'lme4',
              'matlabr',
              'QuantPsyc',
              "RColorBrewer",
              'reshape2',
              'tidyr')
            )
```

# Matlab
```{r}
run_matlab_script('amasino_dataPrep/fit_discount_k.m')
```

# Screening
# Cleaning
see choice_analysis.Rmd

# Read and create datasets
## Exclude subjects
```{r}
# Data on subject level
excludeSubjects <- read.table('data_jupyter/excludeSubjects_choice.csv', 
                           header=TRUE, sep=',')[, 1]
excludeSubjects
```


## data_subject
```{r}
# Data on subject level
data_subject <- read.table('data_jupyter/data_subject.csv', 
                           header=TRUE, sep=',') %>%
    filter(!(run_id %in% excludeSubjects))
alllogk<-read.table(
    "amasino_dataPrep/intermediateCSVs/allLogk.csv", header=FALSE, sep=",")
names(alllogk) = c('run_id', 'logK')
data_subject = merge(data_subject, alllogk, by='run_id')
data_subject = data_subject %>% 
    filter(!is.na(logK))
print(nrow(data_subject))
data_subject
```


## data_trial_choice
```{r}
# Data on Trial level
data_trial_choice <- read.table('data_jupyter/data_trial_choice.csv',
                                header=TRUE, sep=',')  %>%
    filter(run_id %in% data_subject$run_id)

if ('logK' %in% names(data_trial_choice))
    {data_trial_choice = data_trial_choice %>% select(!logK)}
data_trial_choice = merge(
    data_trial_choice,
    data_subject %>% dplyr::select(run_id, logK),
    by='run_id'
)

data_trial_choice = data_trial_choice %>% filter(!is.na(logK))

print(paste('Number of subjects: ', length(unique(data_trial_choice$run_id))))
data_trial_choice %>% dplyr::select(run_id, trial_index, logK)
```

## data_et_choice
```{r}
data_et_choice <- read.table('data_jupyter/data_et_choice.csv', 
                             header=TRUE, sep=',') %>%
    filter(run_id %in% data_subject$run_id)

if ('choseTop' %in% names(data_et_choice))
    {data_et_choice = data_et_choice %>% select(!choseTop)}
data_et_choice = merge(
    data_et_choice, 
    data_trial_choice %>% 
        group_by(run_id, trial_index) %>% 
        summarise(choseTop = mean(choseTop)),
    by=c('run_id', 'trial_index')
)

data_et_choice$lookTopAOI = as.integer(data_et_choice$aoi == 'TL' | data_et_choice$aoi == 'TR')

print(paste('Number of subjects: ', length(unique(data_et_choice$run_id))))

```

```{r}
data_trial_choice$clusters2
```

# Models
## Random Intercept
```{r}

```

## Random Slope
### Offset
```{r}
# https://stats.idre.ucla.edu/r/dae/mixed-effects-logistic-regression/

m1_rs <- glmer(choseLL ~ choiceNr_c + optionIndex + attributeIndex + payneIndex + k + (1 | run_id), 
               data = data_trial_choice, 
               family = binomial, 
               control = glmerControl(optimizer = "bobyqa"),
               nAGQ = 10)

print(model, corr = FALSE)
summary(model)
confint(model, method="boot", n=50) # CI with Bootstrap does not need normality
```

## Visualize with Average Marginal Probability
```{r}
summary(data_trial_choice$optionIndex)
```

```{r}
tmpdat <- data_trial_choice[, c("choiceNr_c", 
                                "optionIndex",  
                                'attributeIndex', 
                                'payneIndex', 
                                'k',    
                                "run_id")]

# sequence of distinct values for predictor of interest
jvalues <- with(data_trial_choice, 
                seq(from = min(optionIndex), 
                    to = max(optionIndex), 
                    length.out = 100))

# calculate predicted probabilities and store in a list
predictions <- lapply(jvalues, function(j) {
    tmpdat$optionIndex <- j
    predict(model, newdata = tmpdat, type = "response")
})
```

```{r}
# average marginal predicted probability across a few different 
plotdat <- sapply(predictions[c(1, 20, 40, 60, 80, 100)], mean, na.rm=TRUE)

# get the means with lower and upper quartiles
# plotdat <- t(sapply(predictions, function(x) {
#               c(M = mean(x), quantile(x,
#                                       c(0.25, 0.75),
#                                       na.rm=na_rm))
#     }
#   )
# )

# add in LengthofStay values and convert to data frame
plotdat <- as.data.frame(cbind(plotdat, jvalues))

# better names and show the first few rows

colnames(plotdat) <- c("PredictedProbability", "optionIndex")
ggplot(plotdat, aes(x = optionIndex, y = PredictedProbability)) + geom_line() +
    ylim(c(0, 1))
```


# H5, H6
```{r prep data}
data_h56 <- read_csv('data_h56.csv')

data_h56$sight = factor(data_h56$sight, 
                    labels = c("glasses", "none", "contact", "perfect"))
data_h56$sight <- relevel(data_h56$sight, ref = "none")
```


## Null 
```{r nullModel}
null <- lmer(offset_perc ~ 1 + (1 | run_id), data_h56)
summary(null)
var.u0i <- unlist(VarCorr(null))
var.rti <- sigma(null)^2
var.u0i / (var.u0i + var.rti)
fixef(null)
ranef(null)
coef(null)
```

ICC = x%. x% of the variance relate to the variance between the subjects 
```{r ICC}
library(ICC)
data_h56$run_id_factor <- as.factor(data_h56$run_id)
ICCest(data_h56$run_id_factor, data_h56$offset_perc, alpha=.05, CI.type="THD")
fixef(null)
ranef(null)
coef(null)
```

## Random Intercept

### Offset
```{r}
model_ri_1 <- lmer(offset_perc ~ 1 + ethnic + positionIndex + fixation_nr + (1 | run_id), data_h56)
model_ri_2 <- lmer(offset_perc ~ 1 + ethnic + positionIndex + fixation_nr + chin + sight + glasses + (1 | run_id), data_h56)
summary(model_ri_2)
confint(model_ri_2, method="boot", n=1000) # CI with Bootstrap does not need normality 
```

### Precision
```{r}
model_ri_1 <- lmer(precision_perc ~ 1 + ethnic + positionIndex + fixation_nr + (1 | run_id), data_h56)
model_ri_2 <- lmer(precision_perc ~ 1 + ethnic + positionIndex + fixation_nr + chin + sight + glasses + (1 | run_id), data_h56)
summary(model_ri_2)
confint(model_ri_2, method="boot", n=1000) # CI with Bootstrap does not need normality 
```

## Random Slope
### Offset
```{r}
model_ri_1 <- lmer(offset_perc ~ 1 + ethnic + positionIndex + fixation_nr + (1 | run_id), data_h56)
model_ri_2 <- lmer(offset_perc ~ 1 + ethnic + positionIndex + fixation_nr + chin + sight + glasses + (1 + chin | run_id), data_h56)
summary(model_ri_2)
confint(model_ri_2, method="boot", n=1000) # CI with Bootstrap does not need normality 
```

### Precision
```{r}
model_ri_1 <- lmer(precision_perc ~ 1 + ethnic + positionIndex + fixation_nr + (1 | run_id), data_h56)
model_ri_2 <- lmer(precision_perc ~ 1 + ethnic + positionIndex + fixation_nr + chin + sight + glasses + (1 + chin | run_id), data_h56)
summary(model_ri_2)
confint(model_ri_2, method="boot", n=1000) # CI with Bootstrap does not need normality 
anova(model_ri_1, model_ri_2, refit=FALSE)
```