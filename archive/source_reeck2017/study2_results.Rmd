---
title: "Study 2 Results"
author: "Dan Wall"
date: "July 28, 2017"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
# load packages
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
ipak(c("nFactors",
       "car",
       "dplyr", 
       "sjPlot",
       "arm",
       "magrittr",
       "XML", 
       "stringr", 
       "tidyr", 
       "reshape2", 
       "ggplot2", 
       "tidyr", 
       "lme4", 
       "fmsb", 
       "plotrix", 
       "dplyr", 
       "effects", 
       "multcomp", 
       "lsmeans",
       "mclust",
       "lubridate",
       "brms",
       "rstan",
       "shinystan",
       "broom",
       "forcats",
       "here", 
       "rlang"
))
# empty workspace
rm(list = ls(all.names = TRUE))
load("study2_data.Rdata")
# function which scales variables but makes them numeric
scale_num <- function(x) {
  scale(x) %>% as.numeric()
}
```

# Main Text Results

```{r setupPayne}
# Join with the avoidant transition dataframe
study2_payne <- study2_payne %>% 
  mutate(serial = as.numeric(serial)) %>% 
  left_join(., study2_nothresh_joy,
            by = c("serial", "id"))

study2_payne <- study2_payne %>% 
  mutate(compliance_ind = joy_ind * -1,
         compliance_fac  = ifelse(compliance_ind == -1, "neg_1",
                                                  ifelse(compliance_ind == 1, "pos_1",
                                                         "other")) %>% 
           factor(levels = c("neg_1", "other", "pos_1")),
         compliance_fac_naother = ifelse(is.na(compliance_fac), "other",
                                         as.character(compliance_fac)) %>% 
           factor(levels = c("neg_1", "other", "pos_1")),
         Easy = ifelse(hard == "hardhoriz", "Integrative",
                       ifelse(hard == "hardvert", "Comparative", NA)) %>% 
           factor,
         total_time_ms_log10 = log10(total_time_ms + 1))



# Ensure we have the dataframe contrast coded
contrasts(study2_payne$accel_delay)<-c(-1,1)
colnames(contrasts(study2_payne$accel_delay))<-c("Delay")
contrasts(study2_payne$Easy)<-c(-1,1)
colnames(contrasts(study2_payne$Easy))<-c("Integrative")
```


## Payne Index Manipulation Check

Participants in the Easy Comparative (M=-0.85) condition had lower Payne Indices than those in the Easy Integrative condition (M=0.87), ??=0.86, s.e.=0.01, p<.001, verifying that the manipulation changed search behavior in the expected direction. 

```{r}
study2_payne %>% 
  group_by(serial, Easy) %>% 
  summarise(mean_pi = mean(payne_ind, na.rm = TRUE)) %>% 
  group_by(Easy) %>% 
  summarise(mean_tot_pi = mean(mean_pi, na.rm = TRUE),
            sd_tot_pit = sd(mean_pi, na.rm = TRUE))
```


```{r}
pi_ht_lmer <- lmer(payne_ind ~ Easy + (1|serial) , study2_payne)
summary(pi_ht_lmer)
Anova(pi_ht_lmer, type = 3)
```

## Choice Model Summary


There was a significant effect of search condition, ??=-0.23, s.e.=0.10, p=.027, with participants in the Easy Comparative condition exhibiting greater patience than those in the Easy Integrative condition. Participants were also more patient when options were framed as decisions to accelerate rather than delay consumption, ??=-0.06, s.e.=0.03, p=.044. The interaction between the two factors was not significant, p = .761. 

```{r}



# We are using the hard transition Payne Index data frame
# We also have only a varying intercept for serial
ch_glmer1ht <- glmer(choice ~ accel_delay * Easy + (1 | serial),
                   study2_payne, family = binomial)

summary(ch_glmer1ht)
Anova(ch_glmer1ht, type = 3)
```



## Effect Plot

```{r}
ch_mlacde02_eff <- Effect(c("accel_delay", "Easy"),
                          ch_glmer1ht) %>%
  as.data.frame() %>%
  mutate(log_odds = log(fit/(1-fit)),
         se_lower_lo = log_odds - se,
         se_upper_lo = log_odds  + se,
         se_lower_pr = invlogit(se_lower_lo),
         se_upper_pr = invlogit(se_upper_lo),
         fit = fit * 100,
         se_lower_pr = se_lower_pr * 100,
         se_upper_pr = se_upper_pr * 100)


(ch_mlacde02_eff_plot <- ggplot(ch_mlacde02_eff, 
                           aes(x = accel_delay, y = fit, group = Easy, linetype = Easy)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = se_lower_pr, ymax = se_upper_pr, width=0.25)) +
  xlab(NULL)+
  ylab("Patient Choices (%)") +
  scale_x_discrete(labels = c("Acceleration", "Delay")) +
  scale_y_continuous(limits = c(0, 65), expand = c(0,0), breaks = seq(0, 60, by = 10)) +
  scale_linetype_discrete(guide = guide_legend(title = "Condition"), labels = c("Easy Comparative", "Easy Integrative")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_blank(),
        text = element_text(size=25),
        axis.title.y=element_text(margin=margin(0,15,0,0))))




# tiff("/Users/Dan/Dropbox/MLWeb/Paper Figures/Figure5.tif", res = 300, width = 2000, height = 2400)
# ch_mlacde02_eff_plot # Make plot
# dev.off()
```

## Only Consistent Trial analysis

We also performed analyses that restricted our analyses to trials in which participants did not use diagonal transitions to avoid the delay (see SI Appendix, Supplemental Results; Fig. 4, right panel). In these data, there were still significant effects of search condition, ??=-0.36, s.e.=0.10, p<.001, and option framing, ??=-0.17, s.e.=0.04, p<.001. Importantly, the interaction between search condition and framing was significant, ??=0.15, s.e.=0.04, p<.001. In alignment with Experiment 1, participants in the Easy Comparative condition exhibited a significant effect of framing, ??=.65, s.e.=0.12, p<.001, while those in the Easy Integrative condition did not, ??=0.04, s.e.=0.10, p=.702. 

```{r}
ch_compl_pos1_glmer4 <- glmer(choice ~ accel_delay * Easy + (1 | serial), 
                         study2_payne %>% 
                           filter(compliance_fac_naother == "pos_1"), family = binomial)

summary(ch_compl_pos1_glmer4)
Anova(ch_compl_pos1_glmer4, type = 3)
```

### Simple Effects

In alignment with Experiment 1, participants in the Easy Comparative condition exhibited a significant effect of framing, β=0.65, s.e.=0.12, p<.001, while those in the Easy Integrative condition did not, β=0.04, s.e.=0.10, p=.702. When using the encouraged search strategy, Comparative search resulted in more sensitivity to framing than Integrative search. 

```{r}
summary(glht(ch_compl_pos1_glmer4, lsm(pairwise ~ accel_delay | Easy)))
```





# Supporting Information Results

## Subjective Experience

Participants completed several measures of their subjective experience performing the task. Participants generally reported agreement that the task was easy and natural to navigate (M = 5.9, s.d. = 1.36), and only 6.8% of the participants indicated they noticed anything unusual. Participants generally reported disagreement that the delays influenced how they performed the task (M = 1.9, s.d. = 1.09) or the choices they made (M = 1.6, s.d. = 0.90). None of these measures differed across the two conditions (p’s > .11). When forced to guess what determined whether there would be a delay in revealing information, only 6 participants guessed the rule governing the manipulation. 

```{r}
study2_feedback %>% 
  mutate(ease_acq_1 = as.numeric(ease_acq_1)) %>% 
  summarise(mean_ease_acq = mean(ease_acq_1, na.rm= TRUE),
            sd_ease_acq = sd(ease_acq_1, na.rm= TRUE))
```

```{r}
study2_feedback$unusual %>% table
```

```{r}
study2_feedback$swift_pertk %>% summary()
```


```{r}
study2_feedback$swift_cngch %>% summary()
```


```{r}
# get the study condition from Payne df
cond <- study2_payne %>%
  group_by(serial) %>% 
  sample_n(1) %>% 
  select(serial, Easy) %>% 
  ungroup %>% 
  mutate(serial = as.character(serial))

study2_feedback <- left_join(study2_feedback, cond,
          by= "serial")

study2_feedback_m <- study2_feedback %>% 
  select(serial, Easy, unusual, swift_pertk, swift_cngch) %>% 
    melt(id = c("serial", "Easy"))

study2_feedback_m %>% 
  group_by(variable) %>% 
  do(tidy(chisq.test(.$value, .$Easy)))
```


## Evolution of Search Strategies

The Payne Index was therefore examined for each trial during the task (Figure S5). 

```{r}
payne_evo_graph <- ggplot(study2_payne_sum, 
       aes(x = round, y = mean_pi, linetype = block, color = hard)) +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .25) +
  scale_y_continuous(limits = c(-1, 1), expand = c(0,0)) +
  scale_x_continuous(limits = c(0, 20), expand = c(0,0)) +
  xlab("Trial") +
  ylab("Mean Payne Index") +
  scale_linetype_discrete(guide = guide_legend(title = "Block"), labels = c("First", "Second")) +
  scale_color_discrete(guide = guide_legend(title = "Condition"), labels = c("Easy Holistic", "Easy Integrative")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
    panel.grid.minor = element_blank())

# tiff("/Users/DanWall/Dropbox/MLWeb/Paper Figures/FigureS5.tif", res = 300, width = 2000, height = 1000)
# payne_evo_graph # Make plot
# dev.off()
```


The difference in Payne Index emerged even within the first trial of the task, t(163) = 17.331, p < .001, d = 2.69

```{r}
t.test(payne_ind ~ hard, data = study2_payne %>% 
         filter(tot_no_choice == 1))
lsr::cohensD(payne_ind ~ hard, data = study2_payne %>% 
         filter(tot_no_choice == 1))

```

## Cluster analysis of 1st 4 choices



Importantly, cluster membership during these initial trials is independent from assigned condition, x2(1) = 0.082, p = .77

```{r}
study2_6trans_first4_z <- study2_6trans %>% 
  filter(tot_no_choice < 5) %>% 
  group_by(hard, serial) %>%
  select(amt_horiz:time_horiz) %>%
  summarise_each(funs(mean)) %>%
  # now Z-score each variable which isn't serial
  mutate_each(funs(scale_num), - serial) %>%
  melt(id = c("serial", "hard")) %>%
  # filter any value which is more than 10 sd from mean
  filter(abs(value) < 10) %>%
  dcast(hard + serial ~ variable) %>%
  na.omit


# now run a k means 2 cluster analysis
km_2_cl_first4_6_trans_ht <- kmeans(study2_6trans_first4_z %>%
                               select(-serial, -hard),
                             2, nstart=15)
# take a look at it
plot(study2_6trans_first4_z %>% select(-serial, -hard),
     col= km_2_cl_first4_6_trans_ht$cluster,pch=1,lwd=2 )

# merge to get cluster in dataframe
study2_6trans_first4_z <-  study2_6trans_first4_z %>% 
  cbind("km_2_cl_first4_6_trans_ht" = km_2_cl_first4_6_trans_ht$cluster)

# look at the table between cluster group and hard transition type
table(study2_6trans_first4_z$hard, study2_6trans_first4_z$km_2_cl_first4_6_trans_ht)

chisq.test(study2_6trans_first4_z$hard, study2_6trans_first4_z$km_2_cl_first4_6_trans_ht)

# now with three clusters

# now run a k means 3 cluster analysis
km_3_cl_first4_6_trans_ht <- kmeans(study2_6trans_first4_z %>%
                                      select(-serial, -hard, -starts_with("km")),
                                    3, nstart=15)
# take a look at it
plot(study2_6trans_first4_z %>% select(-serial, -hard, -starts_with("km")),
     col= km_3_cl_first4_6_trans_ht$cluster,pch=1,lwd=2 )

# merge to get cluster in dataframe
study2_6trans_first4_z <-  study2_6trans_first4_z %>% 
  cbind("km_3_cl_first4_6_trans_ht" = km_3_cl_first4_6_trans_ht$cluster)

# look at the table between cluster group and hard transition type
table(study2_6trans_first4_z$hard, study2_6trans_first4_z$km_3_cl_first4_6_trans_ht)

```


### Choice Model with BIC

NOTE: THESE MODELS HAVE THE TRIALS WHICH DIDN'T HAVE A BOX OPEN DROPPED

#### 2 Cluster model

```{r}

study2_6trans_first4_z <- study2_6trans_first4_z %>% 
                                select(serial, starts_with("km")) %>% 
                                  mutate(serial = as.numeric(serial))
                                         
study2_payne <- left_join(study2_payne, study2_6trans_first4_z ,
                              by = "serial") %>% 
  mutate(km_2_cl_first4_6_trans_ht = factor(km_2_cl_first4_6_trans_ht), 
          km_3_cl_first4_6_trans_ht = factor(km_3_cl_first4_6_trans_ht))


ch_2cl_first4_obo <- glmer(choice ~ km_2_cl_first4_6_trans_ht * accel_delay + (1|serial), 
                data = study2_payne,
                family = "binomial")

summary(ch_2cl_first4_obo)
Anova(ch_2cl_first4_obo)
BIC(ch_2cl_first4_obo)

```

#### 3 cluster model

```{r}
ch_3cl_first4_obo <- glmer(choice ~ km_3_cl_first4_6_trans_ht * accel_delay + (1|serial), 
                data = study2_payne,
                family = "binomial",
                       control=glmerControl(optimizer="bobyqa",
                               optCtrl=list(maxfun=2e5)))

summary(ch_3cl_first4_obo)
Anova(ch_3cl_first4_obo)
BIC(ch_3cl_first4_obo)
```

#### All 2 cluster with hard interaction

Critically, when we include the cluster from the first four trials as a predictor in our analyses of choice, it does not interact with any of the other predictors (p’s > .4), indicating that the early search patterns do not subsequently moderate the results. 


```{r}
ch_2cl_first4_allint_obo <- glmer(choice ~ km_2_cl_first4_6_trans_ht * accel_delay  * hard+ (1|serial), 
                data = study2_payne,
                family = "binomial",
                         control=glmerControl(optimizer="bobyqa",
                                              optCtrl=list(maxfun=2e5)))

summary(ch_2cl_first4_allint_obo)
Anova(ch_2cl_first4_allint_obo)
BIC(ch_2cl_first4_allint_obo)

```




## Adopting the Encouraged Strategy


### Demographics 

Importantly, there were no observed differences in the demographics or any individual difference measures collected between the participants removed and those retained (all p’s > .1).

```{r}
study2_payne_compl <- study2_payne %>% 
  group_by(serial) %>% 
  filter(!(is.na(compliance_ind))) %>% 
  mutate(n_noncomp = sum(compliance_ind != 1, na.rm = TRUE),
         n_q = n(),
         serial_compliance = ifelse(n_noncomp == n_q,
                                    "non_complier",
                                    "complier"))
hard_comp <- study2_payne_compl %>% 
  group_by(serial) %>% 
  sample_n(1) 

chisq.test(hard_comp$hard, hard_comp$serial_compliance)

```

```{r}
hard_comp <- hard_comp %>% 
  ungroup %>% 
  mutate(serial = as.numeric(serial))
study2_info <- study2_info %>% 
  mutate(serial = as.numeric(serial))

hard_comp_mer <- left_join(hard_comp, study2_info) %>% 
  ungroup() %>% 
  mutate(n_nocomp = sum(serial_compliance == "non_complier"),
         n_comp = sum(serial_compliance == "complier"))

# demographics that aren't age
demo_hard_comp <- hard_comp_mer %>% 
  select(serial, hard, n_nocomp, n_comp, serial_compliance, belief_pay:confusing) %>%
  select(-birthyear, - birthmonth, -think_study, - what_unus, - guess_open, -reader) %>% 
  melt(id = c("serial", "hard", "n_nocomp", "n_comp", "serial_compliance")) %>% 
  group_by(variable, value,n_nocomp, n_comp, serial_compliance) %>%
  summarise(n_level = n()) %>% 
  dcast(variable + n_nocomp + n_comp +value ~ serial_compliance, value.var = "n_level") 

demo_hard_comp[is.na(demo_hard_comp)] <- 0


demo_hard_comp %>% 
  filter(variable !="occupation_other") %>% 
  dplyr::group_by(variable) %>% 
  do(broom::tidy(chisq.test(x = .$complier,
                            y = .$non_complier))) %>% 
  mutate(p.value = round(p.value, 2)) %>% 
  arrange(p.value)
```


Percentage of transitions that avoid the manipulation across each trial in the task. The fit line indicates a locally weighted scatter plot smooth. Such transitions were more common early in the task

```{r}
per_avoid_per_item <- study2_nothresh_trans %>% 
  group_by(serial, tot_no_choice) %>% 
  summarise(n_trans_sum = sum(n_trans, na.rm = TRUE),
            n_loophole_sum = n_loophole[1]) %>% 
  ungroup %>% 
  mutate(n_loophole_sum = case_when(is.na(n_loophole_sum) ~ 0L,
                                    !is.na(n_loophole_sum) ~ n_loophole_sum),
         per_loophole = (n_loophole_sum/n_trans_sum)*100) %>% 
  group_by(tot_no_choice) %>% 
  summarise(mean_per_loophole = mean(per_loophole))

(per_avoid_per_item_p <- ggplot(per_avoid_per_item, aes(x = tot_no_choice, y = mean_per_loophole)) +
  geom_point() +
  geom_smooth() +
  scale_x_continuous(name = "Choice", breaks = 1:38) +
  scale_y_continuous(name = "Inconsistent Transitions %", limits = c(0, 50)) +
    theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_blank(),
        text = element_text(size=25),
        axis.title.y=element_text(margin=margin(0,15,0,0))))


tiff("/Users/Dan/Dropbox/MLWeb/Paper Figures/FigureSXPercentAvoidTrans.tif", res = 300, width = 4500, height = 2000)
per_avoid_per_item_p # Make plot
dev.off()

```


### Choice Models

#### Compliance factor interaction

In alignment with the results reported in the prep_global_data text, there was also a significant interaction between option framing and condition, β = 0.24, s.e. = 0.07, p < .001. Importantly, there was also a three-way interaction between the use of diagonal transitions, framing, and condition, (no avoiding transitions versus all avoiding transitions: β = -0.38, s.e. = 0.08, p < .001; mixed versus all avoiding transitions: β = -0.13, s.e. = 0.09, p = .142). Thus, the use of transitions to avoid the manipulation does appear to moderate the effect of the manipulation of search strategy and option framing on choices.





```{r}
ch_compl_glmer4 <- glmer(choice ~ accel_delay * Easy * compliance_fac_naother + (1 | serial), 
                         study2_payne, family = binomial,
                         control=glmerControl(optimizer="bobyqa",
                                              optCtrl=list(maxfun=2e5)))

summary(ch_compl_glmer4)
Anova(ch_compl_glmer4, type = 3)
```

#### Effect Plot

```{r}
ch_complfac_nao_eff <- Effect(c("accel_delay", "Easy", "compliance_fac_naother"), ch_compl_glmer4) %>% 
  as_data_frame() %>% 
  mutate(AccelDelay = factor(accel_delay, labels = c("Acceleration", "Delay")),
         Avoidance = factor(compliance_fac_naother, labels = c("Inconsistent", "Other", "Consistent")),
         Condition = factor(Easy,
                            labels = c("Easy Comparative", "Easy Integrative")),
         log_odds = log(fit/(1-fit)),
         se_lower_lo = log_odds - se,
         se_upper_lo = log_odds  + se,
         se_lower_pr = invlogit(se_lower_lo),
         se_upper_pr = invlogit(se_upper_lo),
         fit = fit * 100,
         se_lower_pr = se_lower_pr * 100,
         se_upper_pr = se_upper_pr * 100)


(ch_complfac_nao_p <- ggplot(ch_complfac_nao_eff, aes(x = Avoidance, y = fit, group = AccelDelay,
                            linetype = AccelDelay)) +
  geom_line() +
  geom_errorbar( aes(ymin = se_lower_pr, ymax = se_upper_pr), width = .25) +
  facet_grid(.~Condition) +
  xlab(NULL) +
  ylab("Patient Choices (%)") +
  scale_linetype_discrete(guide = guide_legend(title = "Frame")) +
  scale_y_continuous(limits = c(0, 65), expand = c(0,0), breaks = seq(0, 60, by = 10)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_blank(),
        text = element_text(size=25),
        axis.title.y=element_text(margin=margin(0,15,0,0))) +
  theme(legend.position=c(.75, .25)))
tiff("/Users/Dan/Dropbox/MLWeb/Paper Figures/FigureSXAvoidance3Way.tif", res = 300, width = 4000, height = 2400)
(ch_complfac_nao_p) # Make plot
dev.off()

ch_complfac_nao_ltcond_p <- ggplot(ch_complfac_nao_eff, aes(x = AccelDelay, y = fit, group = Condition,
                            linetype = Condition)) +
  geom_line() +
  geom_errorbar( aes(ymin = se_lower_pr, ymax = se_upper_pr), width = .25) +
  facet_grid(.~Avoidance) +
  xlab(NULL) +
  ylab("Patient Choices (%)") +
  scale_linetype_discrete(guide = guide_legend(title = "Condition")) +
  scale_y_continuous(limits = c(0, 65), expand = c(0,0), breaks = seq(0, 60, by = 10)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_blank(),
        text = element_text(size=25),
        axis.title.y=element_text(margin=margin(0,15,0,0))) +
  theme(legend.position=c(.5, .25))


tiff("/Users/Dan/Dropbox/MLWeb/Paper Figures/FigureSXAvoidance3WayCondLT.tif", res = 300, width = 4000, height = 2400)
ch_complfac_nao_ltcond_p # Make plot
dev.off()

```

### Consistent Transitions

. Analyses revealed that there was a significant prep_global_data effect condition, β = 0.36, s.e. = 0.10, p < .001, with those in the Easy Comparative condition making more patient choices, and that the prep_global_data effect of framing was significant, β = -0.17, s.e. = 0.04, p< .001. Importantly, and in alignment with our prediction, the interaction between frame and condition was significant, β = -0.15, s.e. = 0.04, p < .001, with trials in the Easy Comparative condition exhibiting an effect of option framing, β = -0.65, s.e. = 0.12, p < .001, while those in the Easy Integrative condition did not, p = .702. Thus, on trials in which the diagonal transitions matched the encouraged search strategy, participants in the Easy Comparative condition made more patient choices and showed a larger effect of acceleration versus delay framing.

See `Only Consistent Trial Analysis` above

### Inconsistent transitions

Finally, we conducted a similar analysis for the trials that only featured diagonal transitions that avoided the search condition manipulation. For these trials, participants are deploying the opposite strategy from the one their condition intended to encourage (e.g., someone in the Easy Comparative condition is actually searching Integratively). Thus, we predicted there would still be an interaction between framing and condition for trials featuring Comparative searching, which in this case would be trials in the Easy Integrative condition. Analyses revealed no prep_global_data effect of framing, β = -0.08, s.e. = 0.07, p =.27, and a significant prep_global_data effect of search condition, β = -0.94, s.e. = 0.31, p < .005, with more patience observed in the Easy Comparative condition. Most critically, the interaction between option framing and search condition was significant, β = .728, s.e. = 0.072, p < .001, with trials in the Easy Integrative condition (which actually featured comparative searching) exhibiting a significant effect of framing, β = -0.91, s.e. = 0.23, p < .001, while trials in the Easy Comparative condition (which actually featured integrative searching) exhibited the opposite pattern, β = 0.39, s.e. = 0.17, p = .019. Thus, on trials in which people were using Comparative search, they exhibited a larger effect of option framing on choice.

```{r}
ch_compl_neg1_glmer4 <- glmer(choice ~ accel_delay * Easy + (1 | serial), 
                              study2_payne %>% 
                                filter(compliance_fac_naother == "neg_1"), family = binomial)

summary(ch_compl_neg1_glmer4)
Anova(ch_compl_neg1_glmer4, type = 3)

```

#### Simple effects

```{r}
summary(glht(ch_compl_neg1_glmer4, lsm(pairwise ~ accel_delay | Easy)))

```


### Mixture transitions

We conducted a similar analysis for the trials that featured a mixture of diagonal transitions that avoided or did not avoid the manipulation (or that featured no diagonal transitions). There was not a significant prep_global_data effect of framing, β = .065, s.e. = 0.06, p = .29, or search condition, β =.061, s.e. = 0.13, p = .64, and the interaction between option framing and search condition was marginally significant, β = 0.1, s.e. = 0.06, p = .095.

```{r}
ch_compl_other_glmer4 <- glmer(choice ~ accel_delay * Easy + (1 | serial), 
                              study2_payne %>% 
                                filter(compliance_fac_naother == "other"), family = binomial)

summary(ch_compl_other_glmer4)
Anova(ch_compl_other_glmer4, type = 3)
```

## Cluster Analysis

```{r}
km_2_cl_6_trans <- kmeans(study2_6trans_all_z %>% select(-serial, -hard), 2, nstart=15)
# take a look at it
# plot(study2_6trans_all_z %>% select(-serial, -hard, -starts_with("km"), -starts_with("mcl")), 
#      col= km_2_cl_6_trans$cluster,pch=1,lwd=2 )

# merge to get cluster in dataframe
study2_6trans_all_z <-  study2_6trans_all_z %>% 
  cbind("km_2cl_6col_all" = km_2_cl_6_trans$cluster)

# look at the table between cluster group and hard transition type
table(study2_6trans_all_z$hard, study2_6trans_all_z$km_2cl_6col_all)


# now run a k means 3 cluster analysis
km_3_cl_6_trans <- kmeans(study2_6trans_all_z %>% select(-serial, -hard,-starts_with("km")),
                          3, nstart=15)
# take a look at it
# plot(study2_6trans_all_z %>% select(-serial, -hard, -starts_with("km"), -starts_with("mcl")), 
#      col= km_3_cl_6_trans$cluster,pch=1,lwd=2 )

# merge to get cluster in dataframe
study2_6trans_all_z <-  study2_6trans_all_z %>% 
  cbind("km_3cl_6col_all" = km_3_cl_6_trans$cluster)


```


### 2 cluster model

### Plots/Descriptives


Summary, Anova, and BIC

```{r}
study2_payne_alltrials <- study2_payne_alltrials %>% 
  mutate(serial = as.character(serial)) %>% 
  left_join(study2_6trans_all_z, by = c("serial", "hard"))

study2_payne_alltrials <- study2_payne_alltrials %>%  
  mutate(km_2cl_6col_all = factor(km_2cl_6col_all))

contrasts(study2_payne_alltrials$km_2cl_6col_all) <- c(-1, 1)

contrasts(study2_payne_alltrials$accel_delay) <- c(-1, 1)

ch_2cl <- glmer(choice ~ km_2cl_6col_all * accel_delay + (1|serial), 
                data = study2_payne_alltrials,
                family = "binomial")

summary(ch_2cl)
Anova(ch_2cl)
BIC(ch_2cl)
```

#### Effects Plot

```{r}
ch_2cl_eff <- Effect(c("km_2cl_6col_all", "accel_delay"), 
                     ch_2cl) %>% 
  as.data.frame()

ggplot(ch_2cl_eff, aes(x = accel_delay, y = fit, color = km_2cl_6col_all, group = km_2cl_6col_all)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower, ymax = upper)) +
  geom_line()
```


#### Simple Effects

```{r}
ch_2cl_pc <- glht(ch_2cl, lsm(pairwise ~ accel_delay|km_2cl_6col_all))
summary(ch_2cl_pc)

```

### Payne Index t-test

```{r}
cluster_sum <- study2_payne_alltrials %>% 
  group_by(serial, km_2cl_6col_all) %>% 
  summarise(mean_pi = mean(payne_ind, na.rm = TRUE))
```

```{r}
t.test(mean_pi ~ km_2cl_6col_all, cluster_sum)
```


```{r}
pi_2cl_all_lmer <- lmer(payne_ind ~ km_2cl_6col_all + (1|serial), 
                        study2_payne_alltrials)
```


### 3 cluster model

### Plots/Descriptives


### Model of choices

Summary, Anova, and BIC

```{r}
ch_3cl <- glmer(choice ~ factor(km_3cl_6col_all) * accel_delay + (1|serial), 
                data = study2_payne_alltrials,
                family = "binomial")

summary(ch_3cl)
Anova(ch_3cl)
BIC(ch_3cl)
```







## Reaction time LMER

Response times greater than three standard deviations from the group mean (representing 0.70% of all trials) were excluded. 

```{r}
# Need to get mean and sd of the total time and mean + (3 * sd)
payne_meantime <- study2_payne %>% 
  summarise(mean = mean(total_time_ms, na.rm = TRUE),
            sd = sd(total_time_ms, na.rm = TRUE)) %>% 
  mutate(max_time = mean + (sd * 3))

study2_payne %>% 
  filter(total_time_ms > payne_meantime$max_time) %>% 
  nrow

study2_payne %>% 
  nrow

50/7175
```

A hierarchical linear regression modeled response times as a function of the framing (acceleration or delay; trial-level predictor) and condition (Easy Comparative or Easy Integrative, participant-level predictor, Figure S11). There was a significant prep_global_data effect of framing, β = -0.01, s.e. = 0.00, p < .001, as responses were faster when choices were framed as a decision to delay consumption. No other effects were significant in the model (p’s > .75)

```{r}
rtlog_lmer <- lmer(total_time_ms_log10 ~ Easy * accel_delay  + (1|serial), 
                study2_payne %>%
                   filter(total_time_ms < payne_meantime$max_time))
summary(rtlog_lmer)
Anova(rtlog_lmer, type = 3)



```


### Effect Plot

```{r}
pwr10m1 <- function(x) {
  (10 ^ x)-1
}

re_log_mlacde02_eff <-  Effect(c("accel_delay", "Easy"),
                              rtlog_lmer) %>%
  as.data.frame() %>%
  mutate(lower_se = fit - se,
         upper_se = fit + se,
         fit_exp = pwr10m1(fit),
         lower_se_exp = pwr10m1(lower_se),
         upper_se_exp = pwr10m1(upper_se),
         Condition = case_when(Easy == "Integrative" ~ "Easy Integrative",
                               Easy == "Comparative" ~ "Easy Comparative"))


(re_log_mlacde01_eff_plot <- ggplot(re_log_mlacde02_eff, 
                               aes(x = accel_delay, y = fit_exp, group = Condition, linetype = Condition)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower_se_exp, ymax = upper_se_exp, width=0.25)) +
  xlab(NULL)+
  ylab("Response Time (msec)") +
  scale_x_discrete(labels = c("Acceleration", "Delay")) +
  # scale_y_continuous(limits = c(5500, 7000), expand = c(0,0), breaks = seq(5500, 7000, by = 250)) +
  scale_linetype_discrete(guide = guide_legend(title = "Strategy"), labels = c("Comparative", "Integrative")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_blank(),
        text = element_text(size=25),
        axis.title.y=element_text(margin=margin(0,15,0,0))))

tiff("/Users/Dan/Dropbox/MLWeb/Paper Figures/FigureS6LogLM.tif", res = 300, width = 2000, height = 2400)
re_log_mlacde01_eff_plot # Make plot
dev.off()

```

## Speeding Patient Choices

This analysis revealed a significant interaction between choice and search condition, β = 0.01, s.e. = 0.00, p < .001. Participants in the Easy Comparative condition made patient choices (M = 6,377 milliseconds) significantly faster than impatient choices (M = 7,269 milliseconds), β = 0.02, s.e. = 0.01, p < .001. There was no difference in response times between patient (M = 6,512 milliseconds) and impatient (M = 6,548 milliseconds) choices for participants in the Easy Integrative condition, p > .2. No other effects or interactions were significant. These findings indicate that comparative search does not appear to lengthen deliberation, but rather speeds patient choices.	

### Means

```{r}
study2_payne %>% 
  filter(total_time_ms < payne_meantime$max_time) %>% 
  group_by(serial, Easy, choice) %>% 
  summarise(mean_pt_rt = mean(total_time_ms, na.rm = TRUE)) %>% 
  group_by(Easy, choice) %>% 
  summarise(mean_cond_rt = mean(mean_pt_rt, na.rm = TRUE),
            sd_cond_rt = sd(mean_pt_rt, na.rm = TRUE))



```


```{r}
study2_payne %>% 
  filter(total_time_ms < payne_meantime$max_time) %>% 
  group_by(serial, Easy, choice) %>% 
  summarise(mean_pt_rt = mean(total_time_ms_log10, na.rm = TRUE)) %>% 
  group_by(Easy, choice) %>% 
  summarise(mean_cond_rt = mean(mean_pt_rt, na.rm = TRUE),
            sd_cond_rt = sd(mean_pt_rt, na.rm = TRUE))


study2_payne %>% 
  filter(total_time_ms < payne_meantime$max_time) %>% 
  nrow

study2_payne %>% 
  filter(total_time_ms < payne_meantime$max_time) %>% 
  group_by(serial, Easy, accel_delay, choice) %>% 
  summarise(mean_pt_rt = mean(total_time_ms_log10, na.rm = TRUE)) %>% 
  group_by(Easy,accel_delay, choice) %>% 
  summarise(mean_cond_rt = mean(mean_pt_rt, na.rm = TRUE),
            sd_cond_rt = sd(mean_pt_rt, na.rm = TRUE))


study2_payne %>% 
  filter(total_time_ms < payne_meantime$max_time) %>% 
  nrow
```


### Model



```{r}

rt_3way_lmer <- lmer(total_time_ms_log10 ~ Easy * accel_delay * choice + (1|serial), 
                study2_payne %>%
                   filter(total_time_ms < payne_meantime$max_time))
summary(rt_3way_lmer)
Anova(rt_3way_lmer, type = 3)
```

## Simple Effects

```{r}
summary(glht(rt_3way_lmer, lsm(pairwise ~ choice | Easy)))

```


## Effect Plot

```{r}
rt_3way_lmer_eff <-  Effect(c("choice", "Easy"),
                              rt_3way_lmer) %>%
  as.data.frame() %>%
  mutate(lower_se = fit - se,
         upper_se = fit + se,
         fit_exp = pwr10m1(fit),
         lower_se_exp = pwr10m1(lower_se),
         upper_se_exp = pwr10m1(upper_se),
         Choice = case_when(choice ==  "ss" ~ "SS",
                            choice == "ll" ~ "LL"),
         Condition = case_when(Easy == "Integrative" ~ "Easy Integrative",
                               Easy == "Comparative" ~ "Easy Comparative"))

rt_3way_lmer_eff

(re_log_mlacde01_eff_plot <- ggplot(rt_3way_lmer_eff, 
                               aes(x = Condition, y = fit_exp, group = Choice, linetype = Choice)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = lower_se_exp, ymax = upper_se_exp, width=0.25)) +
  xlab(NULL)+
  ylab("Response Time (msec)") +
  # scale_x_discrete(labels = c("Acceleration", "Delay")) +
  # scale_y_continuous(limits = c(5500, 7000), expand = c(0,0), breaks = seq(5500, 7000, by = 250)) +
  # scale_linetype_discrete(guide = guide_legend(title = "Strategy"), labels = c("Comparative", "Integrative")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_blank(),
        text = element_text(size=25),
        axis.title.y=element_text(margin=margin(0,15,0,0))))

```


# Combined Plots for Figure 4

```{r}
library(gridExtra)
library(cowplot)


## Study 2 all trials
ch_mlacde02_eff_plot  <- ch_mlacde02_eff_plot + theme(legend.position=c(.5, .25))

## Study 2 only consistent transitions

ch_compl_sub_eff <- Effect(c("accel_delay", "Easy"), ch_compl_pos1_glmer4) %>%
  as_data_frame() %>% 
  mutate(log_odds = log(fit/(1-fit)),
         se_lower_lo = log_odds - se,
         se_upper_lo = log_odds  + se,
         se_lower_pr = invlogit(se_lower_lo),
         se_upper_pr = invlogit(se_upper_lo),
         fit = fit * 100,
         se_lower_pr = se_lower_pr * 100,
         se_upper_pr = se_upper_pr * 100)

ch_compl_sub_eff_plot <- ggplot(ch_compl_sub_eff, 
                           aes(x = accel_delay, y = fit, group = Easy, linetype = Easy)) +
  geom_point() +
  geom_line() +
  geom_errorbar(aes(ymin = se_lower_pr, ymax = se_upper_pr, width=0.25)) +
  xlab(NULL)+
  ylab("Patient Choices (%)") +
  scale_x_discrete(labels = c("Acceleration", "Delay")) +
  scale_y_continuous(limits = c(0, 65), expand = c(0,0), breaks = seq(0, 60, by = 10)) +
  scale_linetype_discrete(guide = guide_legend(title = "Condition"), labels = c("Easy Comparative", "Easy Integrative")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.key = element_blank(),
        text = element_text(size=25),
        axis.title.y=element_text(margin=margin(0,15,0,0)))+ theme(legend.position=c(.5, .25))


# ## Study 1 
# setwd("/git_repositories/crystal_mouselab/Wave_492/")
# # load packages
# # empty workspace
# load("analyzed_data/analyzed_data.RData")
# 
# ch_mlacde01_plot <- ch_mlacde01_plot + theme(legend.position=c(.5, .25))
# 
# 
# tiff("/Users/Dan/Dropbox/MLWeb/Paper Figures/ComplianceFigureCombined.tif", res = 300, width = 6000, height = 3000)
# plot_grid(ch_mlacde01_plot, ch_mlacde02_eff_plot, ch_compl_sub_eff_plot,  labels=c("A", "B", "C"), ncol = 3, nrow = 1, rel_widths = c(1, 1, 1))
#  # Make plot
# dev.off()

```


# Session information/Package Context

```{r}
sessionInfo()
```

