---
title: "MixedRegression"
author: "Tim Schneegans"
date: "4 Januar 2021"
output: html_document
---

```{r setup, message=FALSE, warning=FALSE}
setwd("C:/Users/User/GitHub/WebET_Analysis")
# https://gist.github.com/stevenworthington/3178163
ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}
ipak(c(
    'data.table',
    "dplyr",
    'Hmisc',
    
    "knitr",
    'readr',
    "rsq",
    'lme4',
    'nlme', 
    'reshape',
    "ICC",
    'ggplot2',
    'GGally',
    'reshape2',
    'lme4',
    'compiler',
    'parallel',
    'boot',
    'lattice',
    "lmerTest", # Erhalte p-Werte
    "tinytex"
    )
)

knitr::opts_chunk$set(echo = TRUE)
options(scipen=999) # Show R markdown output as Integers
```

# Prep data
```{r data}
data_et_fix_raw <- read_csv('data_jupyter/data_et_fix.csv')
data_trial_fix_raw <- read_csv('data_jupyter/data_trial_fix.csv')
data_subject_raw <- read_csv('data_jupyter/data_subject.csv')
head(data_et_fix_raw)
head(data_trial_fix_raw)
head(data_subject_raw)
```

## Add glasses to data_et_fix
```{r}
if ('glasses_binary' %in% names(data_trial_fix_raw))
    {data_trial_fix_raw = data_trial_fix_raw %>% select(!glasses_binary)}
data_trial_fix_raw = merge(
    data_trial_fix_raw, 
    data_subject_raw %>% 
        select(run_id, glasses_binary) %>%
        distinct(),
    by='run_id'
)
data_trial_fix_raw
```

# Screening
```{r}
summary(data_et_fix_raw %>%
            select(x, y, t_task)
)
summary(data_trial_fix_raw %>% 
            select(run_id, offset, precision, fps)
)
```

## Very low FPS
```{r}
trialFPS = data_et_fix_raw %>%
    group_by(run_id, trial_index) %>%
    summarise(n = n())

trialFPS = merge(
    trialFPS, 
    data_trial_fix_raw %>% select(run_id, trial_index, trial_duration_exact),
    by=c('run_id', 'trial_index'))
trialFPS$fps = 1000 * trialFPS$n / trialFPS$trial_duration_exact

if ('fps_fix' %in% names(data_subject_raw))
    {data_subject_raw = data_subject_raw %>% select(!fps_fix)}
data_subject_raw = merge(
    data_subject_raw, 
    trialFPS %>% group_by(run_id) %>% summarise(fps_fix = mean(fps)),
    by='run_id'
)
summary(data_subject_raw$fps_fix)

data_subject_raw %>%
    select(run_id, fps_fix) %>%
    filter(fps_fix<3)

subjects_lowFPS = data_subject_raw %>%
    filter(fps_fix<3) %>%
    select(run_id)
subjects_lowFPS
```

# Cleaning
```{r}
excludedSubjects = subjects_lowFPS
excludedSubjects
```

## data_trial_fix
```{r}

data_trial_fix = data_trial_fix_raw %>%
    filter(
        !is.na(precision) & 
        !(run_id %in% excludedSubjects) &
        (trial_duration_exact<5100)
        )
print(paste('Raw: ', nrow(data_trial_fix_raw)))
print(paste('Cleaned: ', nrow(data_trial_fix)))
```

## data_et_fix
On purpose, we don't exclude specific x and y values, neither positive nor negative outliers
```{r}
data_et_fix = data_et_fix_raw %>%
    filter(
        !(run_id %in% excludedSubjects) &
        (t_task<5100)
        )
print(paste('Raw: ', nrow(data_et_fix_raw)))
print(paste('Cleaned: ', nrow(data_et_fix)))
```
# Frame Rate
```{r}
names(data_trial_fix)
```

```{r}

ggplot(data_trial_fix, aes(x = chin, y = fps, fill = chin)) +
  stat_boxplot(geom ='errorbar', size = 0.4, width = 0.1) +
  facet_grid(.~chin, scales = "free") +
  geom_boxplot() +
  scale_y_continuous(limits = c(0, 30)) +
  labs("y" = "fps per trial") +
  guides(fill = F) + 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
dev.copy(png, 'tolcam_stats_fps_setting.png', width=4, height=4, units="in", res=300)
dev.off()

```